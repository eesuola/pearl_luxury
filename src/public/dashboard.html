<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Opaline Vogue Dashboard</title>
  <!-- <link rel="manifest" href="/manifest.json"> -->
  <meta name="mobile-web-app-capable" content="yes">
  <!-- <meta name="apple-mobile-web-app-capable" content="yes"> -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/images/logo-180x180.png">
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
   <div class="container">
    <header>
      <img src="/logo.png" alt="Opaline Vogue Logo" class="logo">
      <h1>Opaline Vogue Dashboard</h1>
    </header>
    <div id="error" class="error"></div>
    <div class="section">
      <h2>Welcome, <span id="userName"></span></h2>
      <button id="createReceiptBtn">Create Receipt</button>
      <button id="getReceiptsBtn">Get Receipts</button>
      <button id="getSalesBookBtn">Get Sales Book</button>
      <button id="logoutBtn">Logout</button>
      <div id="receiptForm" style="display:none;">
        <h3>Create Receipt</h3>
        <form id="receiptFormInner">
          <div class="form-group">
            <label for="customerName">Customer Name:</label>
            <input type="text" id="customerName" name="customerName" required>
          </div>
          <div class="form-group">
            <label for="customerPhoneNumber">Customer Phone Number:</label>
            <input type="text" id="customerPhoneNumber" name="customerPhoneNumber" required>
          </div>
          <div class="form-group">
            <label for="description">Description:</label>
            <input type="text" id="description" name="description" required>
          </div>
          <div id="itemsContainer" class="form-group">
            <label>Items:</label>
            <div class="item-row">
              <input type="text" name="items[0][itemsPurchased]" placeholder="Item Name" required>
              <input type="number" name="items[0][quantity]" placeholder="Qty" min="1" value="1" required>
              <input type="number" name="items[0][price]" placeholder="Price" step="0.01" min="0" required>
              <button type="button" class="remove-item" style="display:none;">Remove</button>
            </div>
          </div>
          <button type="button" id="addItem">Add Item</button>
          <div class="form-group">
            <label for="totalAmount">Total Amount:</label>
            <input type="number" id="totalAmount" name="totalAmount" readonly>
            <button type="button" id="calculateTotal">Calculate Total</button>
          </div>
          <div class="form-group">
            <label for="amountPaid">Amount Paid:</label>
            <input type="number" id="amountPaid" name="amountPaid" step="0.01" min="0" value="0" required>
          </div>
          <div class="form-group">
            <label for="paymentStatus">Payment Status:</label>
            <select id="paymentStatus" name="paymentStatus" required>
              <option value="Unpaid">Unpaid</option>
              <option value="Partially Paid">Partially Paid</option>
              <option value="Paid">Paid</option>
            </select>
          </div>
          <div class="form-group">
            <label for="balanceToPay">Balance to Pay:</label>
            <input type="number" id="balanceToPay" name="balanceToPay" readonly>
          </div>
          <div class="form-group">
            <label for="paymentMethod">Payment Method:</label>
            <select id="paymentMethod" name="paymentMethod" required>
              <option value="Cash">Cash</option>
              <option value="Bank Transfer">Bank Transfer</option>
              <option value="Mobile Payment">Mobile Payment</option>
            </select>
          </div>
          <button type="submit">Generate Receipt</button>
        </form>
      </div>
      <div id="createReceiptData" class="data-section"></div>
      <div id="receiptsData" class="data-section"></div>
      <div id="salesBookData" class="data-section"></div>
      <div id="editPaymentForm" style="display:none;" class="data-section">
        <h3>Edit Payment</h3>
        <form id="editPaymentFormInner">
          <div class="form-group">
            <label for="editAmountPaid">Paid Amount:</label>
            <input type="number" id="editAmountPaid" name="amountPaid" step="0.01" min="0" required>
          </div>
          <div class="form-group">
            <label for="editPaymentStatus">Payment Status:</label>
            <select id="editPaymentStatus" name="paymentStatus" required>
              <option value="Paid">Paid</option>
              <option value="Unpaid">Unpaid</option>
              <option value="Partially Paid">Partially Paid</option>
            </select>
          </div>
          <button type="submit">Update Payment</button>
          <button type="button" id="cancelEdit">Cancel</button>
        </form>
      </div>
    </div>
  </div>
  <script>
    
  let isLoggedIn = !!window.sessionStorage.getItem('loggedIn');

  if (isLoggedIn) {
    const userName = window.sessionStorage.getItem('userName') || 'Unknown';
    document.getElementById('userName').textContent = userName;
    document.querySelector('.section').style.display = 'block';
  } else {
    window.location.href = '/';
  }

  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
      const response = await fetch('/api/logout', { method: 'POST' });
      const data = await response.json();
      if (response.ok) {
        isLoggedIn = false;
        window.sessionStorage.removeItem('loggedIn');
        window.sessionStorage.removeItem('userName');
        window.location.href = "/login.html";
      } else {
        document.getElementById('error').textContent = data.message || 'Logout failed';
      }
    } catch (error) {
      document.getElementById('error').textContent = 'Error during logout: ' + error.message;
    }
  });

  document.getElementById('addItem').addEventListener('click', () => {
    if (!isLoggedIn) return;
    const container = document.getElementById('itemsContainer');
    const rows = container.getElementsByClassName('item-row');
    const index = rows.length;
    const newRow = document.createElement('div');
    newRow.className = 'item-row';
    newRow.innerHTML = `
      <input type="text" name="items[${index}][itemsPurchased]" placeholder="Item Name" required>
      <input type="number" name="items[${index}][quantity]" placeholder="Qty" min="1" value="1" required>
      <input type="number" name="items[${index}][price]" placeholder="Price" step="0.01" min="0" required>
      <button type="button" class="remove-item">Remove</button>
    `;
    newRow.querySelector('.remove-item').addEventListener('click', () => newRow.remove());
    container.appendChild(newRow);
  });

  document.getElementById('calculateTotal').addEventListener('click', () => {
    if (!isLoggedIn) return;
    const items = document.querySelectorAll('.item-row');
    let total = 0;
    items.forEach(row => {
      const quantity = parseFloat(row.querySelector('input[name$="[quantity]"]').value) || 0;
      const price = parseFloat(row.querySelector('input[name$="[price]"]').value) || 0;
      total += quantity * price;
    });
    document.getElementById('totalAmount').value = total.toFixed(2);
    updateBalance();
  });
   document.getElementById('amountPaid').addEventListener('input', updateBalance);
  document.getElementById('totalAmount').addEventListener('input', updateBalance);

  function updateBalance() {
    const total = parseFloat(document.getElementById('totalAmount').value) || 0;
    const paid = parseFloat(document.getElementById('amountPaid').value) || 0;
    document.getElementById('balanceToPay').value = (total - paid).toFixed(2);
  }

  document.getElementById('receiptFormInner').addEventListener('submit', async (e) => {
    if (!isLoggedIn) return;
    e.preventDefault();

    const customerName = document.getElementById('customerName').value.trim();
    const customerPhoneNumber = document.getElementById('customerPhoneNumber').value.trim();
    const description = document.getElementById('description').value.trim();
    const paymentMethod = document.getElementById('paymentMethod').value;
    const items = document.querySelectorAll('.item-row');
    

    if (!customerName || !customerPhoneNumber || !description || !paymentMethod || items.length === 0) {
      document.getElementById('error').textContent = 'All fields are required';
      return;
    }

    // Strictly validate and filter items
    const validItems = Array.from(items).map(row => {
        const name = row.querySelector('input[name$="[itemsPurchased]"]').value.trim();
      const quantity = parseFloat(row.querySelector('input[name$="[quantity]"]').value) || 0;
      const price = parseFloat(row.querySelector('input[name$="[price]"]').value) || 0;
      return { itemsPurchased: name, quantity, price }; // Match schema field name
    }).filter(item => item.itemsPurchased && item.quantity > 0 && item.price >= 0);

    if (validItems.length === 0) {
      document.getElementById('error').textContent = 'At least one valid item is required';
      return;
    }

    let total = 0;
    validItems.forEach(item => {
      total += item.quantity * item.price;
    });
    document.getElementById('totalAmount').value = total.toFixed(2);
    const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
    const paymentStatus = document.getElementById('paymentStatus').value;
    const balanceToPay = parseFloat(document.getElementById('balanceToPay').value) || 0;

    const data = {
  
        customerName,
        customerPhoneNumber,
        description,
        items: validItems,
        totalAmount: total,
        amountPaid,
        paymentStatus, // Default status
        balanceToPay, // Initial balance
        paymentMethod,
    };

    console.log('Submitting data:', data); // Debug log

    try {
      const response = await fetch('/api/create-receipt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `receipt-${Date.now()}.pdf`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        document.getElementById('receiptsData').innerHTML = '';
        document.getElementById('salesBookData').innerHTML = '';
        document.getElementById('createReceiptData').innerHTML = '<p>Receipt created successfully!</p>';
        // Reset form
        document.getElementById('receiptFormInner').reset();
        document.getElementById('getReceiptsBtn').click();
      } else {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to generate receipt');
      }
    } catch (error) {
      document.getElementById('error').textContent = error.message;
    }
  });

  document.getElementById('createReceiptBtn').addEventListener('click', () => {
    if (!isLoggedIn) return;

     document.getElementById('receiptsData').innerHTML = '';
    document.getElementById('salesBookData').innerHTML = '';
    document.getElementById('createReceiptData').innerHTML = '';
    document.getElementById('receiptForm').style.display = 'block';
  });

  document.getElementById('getReceiptsBtn').addEventListener('click', async () => {
    if (!isLoggedIn) return;
    try {
      document.getElementById('salesBookData').innerHTML = '';
      document.getElementById('createReceiptData').innerHTML = '';
      document.getElementById('receiptForm').style.display = 'none';
      const response = await fetch('/api/receipts');
      const receipts = await response.json();
      document.getElementById('receiptsData').innerHTML = receipts.length
        ? '<h3>Past Receipts</h3>' + receipts.map(r => `
            <div class="data-item">
              <p><strong>Order ID:</strong> ${r.orderId}</p>
              <p><strong>Customer:</strong> ${r.customerName}</p>
              <p><strong>Phone:</strong> ${r.customerPhoneNumber}</p>
              <p><strong>Description:</strong> ${r.description}</p>
              <p><strong>Total:</strong> ₦${r.totalAmount.toFixed(2)}</p>
              <p><strong>Paid:</strong> ₦${r.amountPaid.toFixed(2)}</p>
              <p><strong>Balance to Pay:</strong> ₦${r.balanceToPay.toFixed(2)}</p>
              <p><strong>Payment Status:</strong> ${r.paymentStatus}</p>
              <p><strong>Payment Method:</strong> ${r.paymentMethod}</p>
              <p><strong>Date:</strong> ${new Date(r.dateOfPurchase).toLocaleDateString()}</p>
              <p><strong>Items:</strong></p><ul>${r.items.map(i => `<li>${i.itemsPurchased} - Qty: ${i.quantity} - Price: ₦${i.price.toFixed(2)}</li>`).join('')}</ul>
              ${r.paymentStatus !== "Fully Paid" ? `<button onclick="showEditForm('${r.orderId}', ${r.totalAmount}, ${r.amountPaid}, '${r.paymentStatus}')">Edit Payment</button>` : ''}
              <button onclick="downloadReceipt('${r.orderId}')">Download Receipt</button>
            </div>
        `).join('')
        : '<p>No receipts found.</p>';
    } catch (error) {
      document.getElementById('error').textContent = 'Error fetching receipts';
    }
  });
  // Add download function
  window.downloadReceipt = (orderId) => {
  window.open(`/api/${orderId}`, '_blank');
};
      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `receipt-${orderId}.pdf`;
        document.body.appendChild(link);
        link.click();
        link.remove();
      } else {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to download receipt');
      }
     {
      document.getElementById('error').textContent = `Error downloading receipt: ${error.message}`;
    }

   window.showEditForm = (orderId, totalAmount, amountPaid, paymentStatus) => {
      document.getElementById('editPaymentForm').style.display = 'block';
      document.getElementById('editAmountPaid').value = amountPaid.toFixed(2);
      document.getElementById('editPaymentStatus').value = paymentStatus;
      document.getElementById('editPaymentFormInner').onsubmit = async (e) => {
        e.preventDefault();
        const newAmountPaid = parseFloat(document.getElementById('editAmountPaid').value) || 0;
        const newPaymentStatus = document.getElementById('editPaymentStatus').value;
        if (newAmountPaid > totalAmount) {
          document.getElementById('error').textContent = 'Paid amount cannot exceed total amount';
          return;
        }
        const balanceToPay = totalAmount - newAmountPaid;
        const data = { amountPaid: newAmountPaid, paymentStatus: newPaymentStatus, balanceToPay };

        try {
          const response = await fetch(`/api/receipts/${orderId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          if (response.ok) {
            document.getElementById('editPaymentForm').style.display = 'none';
            document.getElementById('getReceiptsBtn').click(); // Refresh receipts
          } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to update payment');
          }
        } catch (error) {
          document.getElementById('error').textContent = error.message;
        }
      };
      document.getElementById('cancelEdit').onclick = () => {
        document.getElementById('editPaymentForm').style.display = 'none';
      };
    };


 document.getElementById('getSalesBookBtn').addEventListener('click', async () => {
      if (!isLoggedIn) return;
      try {
        document.getElementById('receiptsData').innerHTML = '';
        document.getElementById('createReceiptData').innerHTML = '';
        document.getElementById('receiptForm').style.display = 'none';
        const response = await fetch('/api/sales-book');
        const salesBook = await response.json();
        document.getElementById('salesBookData').innerHTML = salesBook.length
          ? '<h3>Sales Book</h3>' + salesBook.map(s => `
            <div class="data-item">
              <p><strong>Order ID:</strong> ${s.orderId}</p>
              <p><strong>Customer:</strong> ${s.customerName}</p>
              <p><strong>Total:</strong> ₦${s.totalAmount.toFixed(2)}</p>
              <p><strong>Paid:</strong> ₦${s.amountPaid.toFixed(2)}</p>
              <p><strong>Balance to Pay:</strong> ₦${s.balanceToPay.toFixed(2)}</p>
              <p><strong>Date:</strong> ${new Date(s.dateOfPurchase).toLocaleDateString()}</p>
            </div>
          `).join('')
          : '<p>No sales book entries found.</p>';
      } catch (error) {
        document.getElementById('error').textContent = 'Error fetching sales book';
      }
    });

  function fetchData() {
    if (isLoggedIn) {
      document.getElementById('getReceiptsBtn').click();
      //document.getElementById('getSalesBookBtn').click();
    }
  }

   // Register Service Worker
    // if ('serviceWorker' in navigator) {
    //   navigator.serviceWorker.register('/sw.js').then(() => {
    //     console.log('Service Worker registered');
    //   }).catch((error) => {
    //     console.error('Service Worker registration failed:', error);
    //   });
    // }
</script>
</body>
</html>