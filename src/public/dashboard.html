<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Opaline Vogue Dashboard</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <header>
      <img src="/logo.png" alt="Opaline Vogue Logo" class="logo">
      <h1>Opaline Vogue Dashboard</h1>
    </header>
    <div id="error" class="error"></div>
    <div class="section">
      <h2>Welcome, <span id="userName"></span></h2>
      <button id="createReceiptBtn">Create Receipt</button>
      <button id="getReceiptsBtn">Get Receipts</button>
      <button id="getSalesBookBtn">Get Sales Book</button>
      <button id="logoutBtn">Logout</button>
      <div id="receiptForm" style="display:none;">
        <h3>Create Receipt</h3>
        <form id="receiptFormInner" action="/api/create-receipt" method="POST">
          <div class="form-group">
            <label for="customerName">Customer Name:</label>
            <input type="text" id="customerName" name="customerName" required>
          </div>
          <div class="form-group">
            <label for="customerPhoneNumber">Customer Phone Number:</label>
            <input type="text" id="customerPhoneNumber" name="customerPhoneNumber" required>
          </div>
          <div id="itemsContainer" class="form-group">
            <label>Items:</label>
            <div class="item-row">
              <input type="text" name="items[0][name]" placeholder="Item Name" required>
              <input type="number" name="items[0][quantity]" placeholder="Qty" min="1" value="1" required>
              <input type="number" name="items[0][price]" placeholder="Price" step="0.01" min="0" required>
              <button type="button" class="remove-item" style="display:none;">Remove</button>
            </div>
          </div>
          <button type="button" id="addItem">Add Item</button>
          <div class="form-group">
            <label for="totalAmount">Total Amount:</label>
            <input type="number" id="totalAmount" name="totalAmount" readonly>
            <button type="button" id="calculateTotal">Calculate Total</button>
          </div>
          <div class="form-group">
            <label for="paymentMethod">Payment Method:</label>
            <select id="paymentMethod" name="paymentMethod" required>
              <option value="Cash">Cash</option>
              <option value="Bank Transfer">Bank Transfer</option>
              <option value="Mobile Payment">Mobile Payment</option>
            </select>
          </div>
          <button type="submit">Generate Receipt</button>
        </form>
      </div>
      <div id="receiptsData" class="data-section"></div>
      <div id="salesBookData" class="data-section"></div>
    </div>
  </div>
  <script>
  let isLoggedIn = !!window.sessionStorage.getItem('loggedIn');

  if (isLoggedIn) {
    const userName = window.sessionStorage.getItem('userName') || 'Unknown';
    document.getElementById('userName').textContent = userName;
    document.querySelector('.section').style.display = 'block';
  } else {
    window.location.href = '/';
  }

  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
      const response = await fetch('/api/logout', { method: 'POST' });
      const data = await response.json();
      if (data.success) {
        isLoggedIn = false;
        window.sessionStorage.removeItem('loggedIn');
        window.sessionStorage.removeItem('userName');
        window.location.href = '/api/login';
      } else {
        document.getElementById('error').textContent = data.message || 'Logout failed';
      }
    } catch (error) {
      document.getElementById('error').textContent = 'Error during logout: ' + error.message;
    }
  });

  document.getElementById('addItem').addEventListener('click', () => {
    if (!isLoggedIn) return;
    const container = document.getElementById('itemsContainer');
    const rows = container.getElementsByClassName('item-row');
    const index = rows.length;
    const newRow = document.createElement('div');
    newRow.className = 'item-row';
    newRow.innerHTML = `
      <input type="text" name="items[${index}][name]" placeholder="Item Name" required>
      <input type="number" name="items[${index}][quantity]" placeholder="Qty" min="1" value="1" required>
      <input type="number" name="items[${index}][price]" placeholder="Price" step="0.01" min="0" required>
      <button type="button" class="remove-item">Remove</button>
    `;
    newRow.querySelector('.remove-item').addEventListener('click', () => newRow.remove());
    container.appendChild(newRow);
  });

  document.getElementById('calculateTotal').addEventListener('click', () => {
    if (!isLoggedIn) return;
    const items = document.querySelectorAll('.item-row');
    let total = 0;
    items.forEach(row => {
      const quantity = parseFloat(row.querySelector('input[name$="[quantity]"]').value) || 0;
      const price = parseFloat(row.querySelector('input[name$="[price]"]').value) || 0;
      total += quantity * price;
    });
    document.getElementById('totalAmount').value = total.toFixed(2);
  });

  document.getElementById('receiptFormInner').addEventListener('submit', async (e) => {
    if (!isLoggedIn) return;
    e.preventDefault();

    const customerName = document.getElementById('customerName').value.trim();
    const customerPhoneNumber = document.getElementById('customerPhoneNumber').value.trim();
    const paymentMethod = document.getElementById('paymentMethod').value;
    const items = document.querySelectorAll('.item-row');

    if (!customerName || !customerPhoneNumber || !paymentMethod || items.length === 0) {
      document.getElementById('error').textContent = 'All fields are required';
      return;
    }

    // Strictly validate and filter items
    const validItems = Array.from(items).map(row => {
      const name = row.querySelector('input[name$="[name]"]').value.trim();
      const quantity = parseFloat(row.querySelector('input[name$="[quantity]"]').value) || 0;
      const price = parseFloat(row.querySelector('input[name$="[price]"]').value) || 0;
      return { itemsPurchased: name, quantity, price }; // Match schema field name
    }).filter(item => item.itemsPurchased && item.quantity > 0 && item.price >= 0);

    if (validItems.length === 0) {
      document.getElementById('error').textContent = 'At least one valid item is required';
      return;
    }

    let total = 0;
    validItems.forEach(item => {
      total += item.quantity * item.price;
    });
    document.getElementById('totalAmount').value = total.toFixed(2);

    const data = {
      receiptId: `REC-${Date.now()}`, // Generate a unique receipt ID
      customerName,
      customerPhoneNumber,
      items: validItems,
      totalAmount: total,
      paymentMethod,
    };

    console.log('Submitting data:', data); // Debug log

    try {
      const response = await fetch('http://localhost:5050/api/create-receipt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `receipt-${Date.now()}.pdf`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        fetchData();
      } else {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to generate receipt');
      }
    } catch (error) {
      document.getElementById('error').textContent = error.message;
    }
  });

  document.getElementById('createReceiptBtn').addEventListener('click', () => {
    if (!isLoggedIn) return;
    document.getElementById('receiptForm').style.display = 'block';
  });

  document.getElementById('getReceiptsBtn').addEventListener('click', async () => {
    if (!isLoggedIn) return;
    try {
      const response = await fetch('/api/receipts');
      const receipts = await response.json();
      document.getElementById('receiptsData').innerHTML = receipts.length
        ? '<h3>Past Receipts</h3>' + receipts.map(r => `
          <div class="data-item">
            <p><strong>Receipt ID:</strong> ${r.receiptId}</p>
            <p><strong>Company:</strong> ${r.companyName}</p>
            <p><strong>Address:</strong> ${r.companyAddress}</p>
            <p><strong>Customer:</strong> ${r.customerName}</p>
            <p><strong>Phone:</strong> ${r.customerPhoneNumber}</p>
            <p><strong>Total:</strong> $${r.totalAmount}</p>
            <p><strong>Payment Method:</strong> ${r.paymentMethod}</p>
            <p><strong>Date:</strong> ${new Date(r.dateOfPurchase).toLocaleDateString()}</p>
            <p><strong>Items:</strong></p><ul>${r.items.map(i => `<li>${i.itemsPurchased} - Qty: ${i.quantity} - Price: $${i.price}</li>`).join('')}</ul>
          </div>
        `).join('')
        : '<p>No receipts found.</p>';
    } catch (error) {
      document.getElementById('error').textContent = 'Error fetching receipts';
    }
  });

  document.getElementById('getSalesBookBtn').addEventListener('click', async () => {
    if (!isLoggedIn) return;
    try {
      const response = await fetch('/api/sales-book');
      const salesBook = await response.json();
      document.getElementById('salesBookData').innerHTML = salesBook.length
        ? '<h3>Sales Book</h3>' + salesBook.map(s => `
          <div class="data-item">
            <p><strong>Receipt ID:</strong> ${s.receiptId}</p>
            <p><strong>Company:</strong> ${s.companyName}</p>
            <p><strong>Address:</strong> ${s.companyAddress}</p>
            <p><strong>Customer:</strong> ${s.customerName}</p>
            <p><strong>Total:</strong> $${s.totalAmount}</p>
            <p><strong>Date:</strong> ${new Date(s.dateOfPurchase).toLocaleDateString()}</p>
          </div>
        `).join('')
        : '<p>No sales book entries found.</p>';
    } catch (error) {
      document.getElementById('error').textContent = 'Error fetching sales book';
    }
  });

  function fetchData() {
    if (isLoggedIn) {
      document.getElementById('getReceiptsBtn').click();
      document.getElementById('getSalesBookBtn').click();
    }
  }
</script>
</body>
</html>